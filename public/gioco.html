<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Serata Giochi – Gioco</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <style>
    body { 
      font-family: sans-serif; color: white; background: #111; text-align: center; margin:0; padding:20px;
    }
    #question-container { max-width: 800px; margin: auto; }
    #question-image { max-width: 100%; border-radius:10px; margin-bottom:20px; }
    #question-text { font-size: 2em; margin: 20px 0; }
    .answer-btn {
      display: block; width: 80%; margin: 10px auto;
      padding: 20px; font-size: 1.5em; border:none; border-radius:10px; cursor:pointer;
    }
    #controls { margin-top:40px; }
    #controls button {
      margin:0 10px; padding:10px 20px; font-size:1em; border:none; border-radius:5px; cursor:pointer;
    }
    #scores-list { text-align: left; display: inline-block; margin-top:20px; }
  </style>
</head>
<body>
  <h1>🎲 Serata Giochi – Quiz</h1>
  <div id="question-container">
    <img id="question-image" src="" alt="" style="display:none;">
    <div id="question-text"></div>
    <div id="answers"></div>
  </div>

  <div id="controls">
    <button id="startBtn">▶️ Avvia Gioco</button>
    <button id="showAnswerBtn" disabled>🔍 Mostra Risposta</button>
    <button id="nextQuestionBtn" disabled>⏭️ Domanda Successiva</button>
    <button id="showScoresBtn" disabled>📋 Mostra Classifica</button>
  </div>

  <div id="scores-list" style="display:none;">
    <h2>🏆 Classifica</h2>
    <ol id="scores"></ol>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io();
    const params = new URLSearchParams(window.location.search);
    const room  = params.get('room');
    // quiz id lo puoi usare se ti serve
    // const quiz  = params.get('quiz');

    const questionImage = document.getElementById('question-image');
    const questionText  = document.getElementById('question-text');
    const answersDiv    = document.getElementById('answers');
    const startBtn      = document.getElementById('startBtn');
    const showAnswerBtn = document.getElementById('showAnswerBtn');
    const nextQBtn      = document.getElementById('nextQuestionBtn');
    const showScoresBtn = document.getElementById('showScoresBtn');
    const scoresList    = document.getElementById('scores-list');
    const scoresOl      = document.getElementById('scores');

    // Join dell’host alla stanza di gioco
    socket.emit('join-host', room);

    startBtn.onclick = () => {
      socket.emit('start-game', room);
      startBtn.disabled = true;
    };

    // Arriva una nuova domanda
    socket.on('new-question', q => {
      // reset UI
      scoresList.style.display = 'none';
      showAnswerBtn.disabled = false;
      nextQBtn.disabled      = true;
      showScoresBtn.disabled = true;
      answersDiv.innerHTML   = '';
      questionText.textContent = q.testo;
      if (q.immagine) {
        questionImage.src = q.immagine;
        questionImage.style.display = 'block';
      } else {
        questionImage.style.display = 'none';
      }
      // mostra le 4 risposte
      q.risposte.forEach((r,i) => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.textContent = r;
        btn.disabled = true;
        answersDiv.appendChild(btn);
      });
    });

    // L’host clicca “Mostra risposta”
    showAnswerBtn.onclick = () => {
      socket.emit('show-answer', {
        room,
        answer: questionText.textContent && [...answersDiv.children]
          .find(btn => btn.textContent === q.corretta)?.textContent
      });
      showAnswerBtn.disabled = true;
      nextQBtn.disabled      = false;
      showScoresBtn.disabled = false;
    };

    // Arriva l’evento per evidenziare la risposta corretta
    socket.on('reveal-answer', correct => {
      [...answersDiv.children].forEach(btn => {
        if (btn.textContent === correct) {
          btn.style.border = '5px solid lime';
        } else {
          btn.style.opacity = '0.5';
        }
      });
    });

    // “Domanda successiva”
    nextQBtn.onclick = () => {
      socket.emit('start-game', room);
      nextQBtn.disabled = true;
      showAnswerBtn.disabled = false;
    };

    // “Mostra classifica”
    showScoresBtn.onclick = () => {
      socket.emit('get-scores', room);
    };

    // Arriva classifica
    socket.on('scores', obj => {
      scoresOl.innerHTML = '';
      Object.entries(obj)
        .sort((a,b)=> b[1] - a[1])
        .forEach(([name,pts]) => {
          const li = document.createElement('li');
          li.textContent = `${name}: ${pts} pt`;
          scoresOl.appendChild(li);
        });
      scoresList.style.display = 'block';
    });
  </script>
</body>
</html>
