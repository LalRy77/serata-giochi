<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Host — Serata Giochi</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:#111; color:#fff; font-family:sans-serif; }
    #controls { padding:1em; text-align:center; background:#222; }
    #controls button { font-size:1.2rem; margin:0 .5em; padding:.5em 1em; }
    #intro, #question, #ranking { display:none; width:100%; text-align:center; padding-top:2em; box-sizing:border-box; }
    #intro img, #intro video { max-width:80%; max-height:60vh; border-radius:10px; }
    #question h1 { font-size:3rem; margin:1em 0; }
    #question img { max-width:80%; border-radius:10px; }
    #question p { font-size:2rem; margin:1em; }
    #ranking { max-width:400px; margin:2em auto; text-align:left; font-size:1.2rem; }
  </style>
</head>
<body>
  <div id="controls">
    <button onclick="showAnswer()">Mostra risposta</button>
    <button onclick="nextQ()">Domanda successiva</button>
    <button onclick="getRank()">Classifica</button>
  </div>

  <div id="intro">
    <h1 id="countdown">3</h1>
    <img id="introImg" src="" alt="" style="display:none">
    <video id="introVid" controls style="display:none; max-width:80%; border-radius:10px"></video>
  </div>

  <div id="question">
    <h1 id="num">Domanda —</h1>
    <img id="qImg" src="" alt=""><br>
    <p id="qText"></p>
    <p id="ans" style="color:#2ecc71; font-size:2rem;"></p>
  </div>

  <div id="ranking"></div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io();
    const params = new URLSearchParams(location.search);
    const room = params.get('room');

    let current = null;

    // Quando l'host clicca "Inizia il Gioco" su host.html,
    // arriva qui l'evento 'new-question' per partire subito.
    socket.on('new-question', q => {
      current = q;
      // fai il countdown 3…2…1
      let cnt = 3;
      document.getElementById('controls').style.display = 'none';
      document.getElementById('introImg').style.display = 'none';
      document.getElementById('introVid').style.display = 'none';
      document.getElementById('question').style.display = 'none';
      document.getElementById('ranking').style.display = 'none';
      const cdEl = document.getElementById('countdown');
      document.getElementById('intro').style.display = 'block';
      cdEl.textContent = cnt;
      const timer = setInterval(() => {
        cnt--;
        if (cnt > 0) {
          cdEl.textContent = cnt;
        } else {
          clearInterval(timer);
          showQuestion(q);
        }
      }, 1000);
    });

    function showQuestion(q) {
      document.getElementById('intro').style.display = 'none';
      document.getElementById('question').style.display = 'block';
      document.getElementById('ans').textContent = '';
      document.getElementById('num').textContent = `Domanda ${q.numero}`;
      document.getElementById('qImg').src = q.immagine;
      document.getElementById('qText').textContent = q.testo;
      document.getElementById('controls').style.display = 'block';
    }

    function showAnswer() {
      if (!current) return;
      document.getElementById('ans').textContent = `Risposta giusta: ${current.corretta}`;
    }
    function nextQ() {
      socket.emit('start-game', room);
    }
    function getRank() {
      socket.emit('get-ranking', room);
    }

    socket.on('ranking', list => {
      document.getElementById('ranking').innerHTML =
        '<h2>Classifica</h2>' +
        list.map((p,i)=>`<p>${i+1}. ${p.nome} — ${p.punti} pt</p>`).join('');
      document.getElementById('question').style.display = 'none';
      document.getElementById('ranking').style.display = 'block';
    });
  </script>
</body>
</html>
