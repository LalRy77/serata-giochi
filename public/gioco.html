<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Host — Serata Giochi</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { margin:0; background:#222; color:#fff; font-family:sans-serif; }
    #controls { padding:1em; text-align:center; }
    #controls button{ font-size:1.2rem; margin:0 .5em; padding:.5em 1em; }
    #intro, #question, #ranking { display:none; text-align:center; }
    #intro img, #intro video { max-width:80%; max-height:60vh; border-radius:10px;}
    #question h1{ font-size:3rem; margin:1em 0;}
    #question p{ font-size:2rem; margin:1em;}
    #ranking{ max-width:400px; margin:2em auto; text-align:left;}
  </style>
</head>
<body>
  <div id="controls">
    <button onclick="showAnswer()">Mostra risposta</button>
    <button onclick="nextQ()">Domanda successiva</button>
    <button onclick="getRank()">Classifica</button>
  </div>

  <!-- 1) Intro media -->
  <div id="intro">
    <img id="introImg" src="" alt="">
    <video id="introVid" controls style="display:none;"></video>
  </div>

  <!-- 2) Vera domanda -->
  <div id="question">
    <h1 id="num">Domanda —</h1>
    <img id="qImg" src="" alt="" style="max-width:80%;border-radius:10px;"><br>
    <p id="qText"></p>
    <p id="ans" style="font-size:2rem;color:#2ecc71;"></p>
  </div>

  <!-- 3) Ranking -->
  <div id="ranking"></div>

  <script>
    const socket = io();
    const p = new URLSearchParams(location.search);
    const room = p.get('room');

    let current = null;

    socket.emit('start-game', room);

    socket.on('new-question', q=>{
      current = q;
      // prima mando intro
      socket.emit('request-intro', room);
      // server deve rispondere con show-intro: {immagine, video?, durata}
    });

    socket.on('show-intro', m=>{
      document.getElementById('introVid').style.display = m.video?'block':'none';
      document.getElementById('introImg').style.display = m.video?'none':'block';
      if(m.video) document.getElementById('introVid').src = m.video;
      else        document.getElementById('introImg').src = m.immagine;
      toggle('intro');
      setTimeout(()=>{
        renderQuestion();
      }, m.durata||3000);
    });

    function renderQuestion(){
      toggle('question');
      document.getElementById('ans').innerText = '';
      document.getElementById('num').innerText = `Domanda ${current.numero}`;
      document.getElementById('qImg').src = current.immagine;
      document.getElementById('qText').innerText = current.testo;
    }

    function showAnswer(){
      if(!current) return;
      document.getElementById('ans')
        .innerText = `Risposta giusta: ${current.corretta}`;
    }

    function nextQ(){
      socket.emit('start-game', room);
    }

    function getRank(){
      socket.emit('get-ranking', room);
    }

    socket.on('ranking', list=>{
      const r = document.getElementById('ranking');
      r.innerHTML = '<h2>Classifica</h2>'+list.map((p,i)=>
        `<p>${i+1}. ${p.nome} — ${p.punti} pt</p>`
      ).join('');
      toggle('ranking');
    });

    function toggle(id){
      ['intro','question','ranking'].forEach(x=>
        document.getElementById(x).style.display = x===id?'block':'none'
      );
    }
  </script>
</body>
</html>
